<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Halloween Event Survey — School</title>
<style>
  :root{--accent:#7b2cbf;--muted:#666;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fffaf6;color:#111;margin:0;padding:16px}
  .wrap{max-width:820px;margin:18px auto;padding:20px;border-radius:12px;background:#fff;box-shadow:0 6px 24px rgba(0,0,0,.06)}
  h1{margin:0 0 8px;font-size:1.6rem;color:var(--accent)}
  p.lead{margin:0 0 18px;color:var(--muted)}
  label{display:block;margin:12px 0 6px;font-weight:600}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;box-sizing:border-box}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:white;border:0;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  .muted{color:var(--muted);font-size:.9rem}
  small.note{display:block;margin-top:6px;color:#8b8b8b}
  .center{text-align:center}
  .qr-box{display:flex;gap:12px;align-items:center;margin-top:8px}
  .qr-canvas{width:120px;height:120px;background:#fff;padding:6px;border-radius:8px;border:1px dashed #eee}
  .admin-panel{margin-top:18px;border-top:1px dashed #eee;padding-top:18px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  table th, table td{border:1px solid #eee;padding:8px;text-align:left;font-size:.9rem}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3ecff;color:var(--accent);font-weight:600}
  .danger{background:#ffecec;color:#d00}
  .ok{background:#ecffef;color:#007a3d}
  @media(min-width:900px){ .row .col.half{flex:0 0 48%} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Halloween Event — Student Survey</h1>
  <p class="lead">Please scan the QR you were given or use this page to submit feedback about today's Halloween events. One submission per student (best-effort enforcement).</p>

  <form id="surveyForm">
    <label for="studentName">Full name</label>
    <input id="studentName" name="studentName" required placeholder="First Last" type="text" />

    <div class="row">
      <div class="col half">
        <label for="grade">Grade</label>
        <select id="grade" name="grade" required>
          <option value="">Select grade</option>
          <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
        </select>
      </div>
      <div class="col half">
        <label for="studentId">Student ID (required)</label>
        <input id="studentId" name="studentId" required placeholder="e.g. 2025123" type="text" />
        <small class="note">We use the Student ID to prevent duplicate submissions on this device.</small>
      </div>
    </div>

    <label for="eventsRated">Which events did you attend? (check all)</label>
    <div>
      <label><input type="checkbox" name="events" value="Haunted House"> Haunted House</label><br>
      <label><input type="checkbox" name="events" value="Costume Contest"> Costume Contest</label><br>
      <label><input type="checkbox" name="events" value="Pumpkin Carving"> Pumpkin Carving</label><br>
      <label><input type="checkbox" name="events" value="Spooky Trivia"> Spooky Trivia</label><br>
      <label><input type="checkbox" name="events" value="Carnival Games"> Carnival Games</label>
    </div>

    <label for="rating">Overall event rating (1-5)</label>
    <select id="rating" name="rating" required>
      <option value="">Select rating</option>
      <option>5 — Amazing</option>
      <option>4 — Great</option>
      <option>3 — Okay</option>
      <option>2 — Needs work</option>
      <option>1 — Poor</option>
    </select>

    <label for="comments">Comments / suggestions (optional)</label>
    <textarea id="comments" name="comments" rows="4" placeholder="What did you like? What could be improved?"></textarea>

    <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
      <button class="btn" type="submit">Submit feedback</button>
      <button id="clearBtn" type="button" class="btn ghost">Clear saved data (admin use)</button>
      <div style="margin-left:auto" class="muted">Submissions saved locally on this page.</div>
    </div>

    <small style="display:block;margin-top:8px;color:#8b8b8b">
      Privacy note: Only capture what your school policy allows. This prototype stores submissions locally in the browser. For central collection and stronger single-submission enforcement, use a server-backed solution.
    </small>

  </form>

  <div class="admin-panel">
    <h3>Admin — Results & QR</h3>

    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <div>
        <label>Admin password</label><br>
        <input id="adminPass" placeholder="Enter admin password"/>
        <button id="adminUnlock" class="btn">Unlock Admin</button>
      </div>

      <div style="margin-left:auto">
        <label>Page URL for QR generation</label><br>
        <input id="pageUrl" placeholder="https://your-hosted-page.example/index.html" style="width:420px" />
        <button id="genQr" class="btn ghost">Generate QR</button>
      </div>
    </div>

    <div style="margin-top:12px" class="qr-box">
      <div id="qrcanvas" class="qr-canvas"></div>
      <div>
        <div id="qrText" class="muted">QR will appear here</div>
        <small class="note">Scan this QR with a phone to open the student form.</small>
      </div>
    </div>

    <div id="adminArea" style="display:none;margin-top:16px">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="badge">Admin mode</div>
        <button id="exportCsv" class="btn">Download CSV</button>
        <button id="clearAll" class="btn danger">Delete all local submissions</button>
        <small class="muted" style="margin-left:12px">Data below comes from browser localStorage on this device.</small>
      </div>

      <div id="results" style="margin-top:12px"></div>
    </div>

    <p class="muted" style="margin-top:12px">Admin default password is <code>halloweenAdmin2025</code>. Change it in the source if you publish publicly.</p>
  </div>
</div>

<!-- QRCode library (tiny, MIT) -->
<script>
/*!
 * Minimal QRCode generator (v1) - tiny footprint version
 * Attribution: adapted/mini version to avoid external dependencies
 */
function generateTinyQR(text, size, container){
  // Use Google's Chart API as a quick fallback (no network when hosted offline won't show)
  // Instead implement a tiny fallback that uses an SVG via chart.googleapis only if online.
  // Simpler: use one-line iframe to google chart. But to keep it purely client-side, we'll create a simple image URL to Google Chart API.
  try{
    var url = "https://chart.googleapis.com/chart?cht=qr&chs="+size+"x"+size+"&chl="+encodeURIComponent(text);
    container.innerHTML = "<img src='"+url+"' alt='QR' style='width:100%;height:100%;object-fit:contain;border-radius:6px' />";
  }catch(e){
    container.textContent = "QR generation failed";
  }
}
</script>

<script>
/* ---------- Simple client-only storage & duplicate check ---------- */
/* Configuration */
const ADMIN_PASSWORD = "halloweenAdmin2025"; // change this if you host publicly
const STORAGE_KEY = "halloween_survey_submissions_v1";
const SUBMITTED_IDS_KEY = "halloween_submitted_ids_v1";

/* Helpers */
function loadSubmissions(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return [];}
}
function saveSubmissions(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}
function loadSubmittedIDs(){
  try{
    const raw = localStorage.getItem(SUBMITTED_IDS_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return [];}
}
function saveSubmittedIDs(arr){
  localStorage.setItem(SUBMITTED_IDS_KEY, JSON.stringify(arr));
}
function addSubmittedID(id){
  const arr = loadSubmittedIDs();
  if(!arr.includes(id)) { arr.push(id); saveSubmittedIDs(arr); }
}

/* On form submit */
document.getElementById('surveyForm').addEventListener('submit', function(ev){
  ev.preventDefault();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('grade').value;
  const studentId = document.getElementById('studentId').value.trim();
  const comments = document.getElementById('comments').value.trim();
  const rating = document.getElementById('rating').value;
  const checkedEvents = Array.from(document.querySelectorAll('input[name="events"]:checked')).map(n=>n.value);

  if(!name || !studentId || !grade || !rating){
    alert("Please complete name, grade, student ID, and rating.");
    return;
  }

  // Best-effort duplicate block
  const submittedIDs = loadSubmittedIDs();
  if(submittedIDs.includes(studentId)){
    alert("We detected that this Student ID already submitted from this device/browser. If you believe this is a mistake, contact the admin.");
    return;
  }

  // Save submission locally
  const subs = loadSubmissions();
  const entry = {
    id: (Math.random().toString(36).slice(2,9)),
    timestamp: new Date().toISOString(),
    studentName: name,
    grade,
    studentId,
    events: checkedEvents,
    rating,
    comments
  };
  subs.push(entry);
  saveSubmissions(subs);
  addSubmittedID(studentId);

  // Set a cookie too (extra local check)
  try{
    document.cookie = "halloween_submitted_"+encodeURIComponent(studentId)+"=1;max-age="+60*60*24*365+";path=/";
  }catch(e){}

  alert("Thanks! Your feedback has been recorded for this device/browser.");
  this.reset();
});

/* Admin unlock & show results */
document.getElementById('adminUnlock').addEventListener('click', function(){
  const pass = document.getElementById('adminPass').value || "";
  if(pass !== ADMIN_PASSWORD){
    alert("Incorrect admin password.");
    return;
  }
  document.getElementById('adminArea').style.display = 'block';
  renderResults();
});

/* Render results table */
function renderResults(){
  const subs = loadSubmissions();
  const el = document.getElementById('results');
  if(!subs.length){
    el.innerHTML = "<p class='muted'>No submissions yet (local storage on this device).</p>";
    return;
  }
  // Build table
  let html = "<table><thead><tr><th>Time</th><th>Name</th><th>Grade</th><th>Student ID</th><th>Events</th><th>Rating</th><th>Comments</th></tr></thead><tbody>";
  subs.slice().reverse().forEach(s=>{
    html += "<tr>";
    html += "<td>"+(new Date(s.timestamp)).toLocaleString()+"</td>";
    html += "<td>"+escapeHtml(s.studentName)+"</td>";
    html += "<td>"+escapeHtml(s.grade)+"</td>";
    html += "<td>"+escapeHtml(s.studentId)+"</td>";
    html += "<td>"+escapeHtml((s.events||[]).join(", "))+"</td>";
    html += "<td>"+escapeHtml(s.rating)+"</td>";
    html += "<td>"+escapeHtml(s.comments||"")+"</td>";
    html += "</tr>";
  });
  html += "</tbody></table>";
  el.innerHTML = html;
}

/* CSV export */
function toCSV(arr){
  const headers = ["timestamp","studentName","grade","studentId","events","rating","comments"];
  const rows = arr.map(r=>[
    r.timestamp,
    r.studentName,
    r.grade,
    r.studentId,
    (r.events||[]).join("; "),
    r.rating,
    r.comments ? r.comments.replace(/\r?\n/g,' ') : ""
  ]);
  const csv = [headers, ...rows].map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(",")).join("\n");
  return csv;
}
document.getElementById('exportCsv').addEventListener('click', function(){
  const subs = loadSubmissions();
  if(!subs.length){ alert("No submissions to export."); return; }
  const csv = toCSV(subs);
  // trigger download
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'halloween_survey_responses.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* Clear all local submissions (admin) */
document.getElementById('clearAll').addEventListener('click', function(){
  if(!confirm("Delete ALL local submissions (for this browser)? This action cannot be undone.")) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(SUBMITTED_IDS_KEY);
  renderResults();
});

/* Clear saved data (student/dev) */
document.getElementById('clearBtn').addEventListener('click', function(){
  if(confirm("This will clear all submissions and submitted-ID markers from this browser. Only do this for debug/admin.") ){
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(SUBMITTED_IDS_KEY);
    alert("Local data cleared.");
  }
});

/* QR generation */
document.getElementById('genQr').addEventListener('click', function(){
  const url = document.getElementById('pageUrl').value.trim();
  if(!url){
    alert("Paste the hosted page URL into the field. Example: https://your-school.github.io/halloween/index.html");
    return;
  }
  document.getElementById('qrText').textContent = "QR for: "+url;
  generateTinyQR(url, 300, document.getElementById('qrcanvas'));
});

/* small helper escape */
function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

/* Initialize with sample page URL (makes testing fast) */
(function init(){
  // Pre-fill pageUrl with current location (helpful if you host this file and open it)
  try{
    document.getElementById('pageUrl').value = location.href;
  }catch(e){}
})();
</script>
</body>
</html>
